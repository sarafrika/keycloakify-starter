# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a Keycloakify v11 starter project that creates custom Keycloak authentication themes using React, TypeScript, and Tailwind CSS. Keycloakify allows you to build Keycloak themes as standard React applications that compile to JAR files for deployment in Keycloak.

## Essential Commands

### Development
```bash
yarn dev                    # Start Vite development server
yarn storybook             # Launch Storybook on port 6006 for component development
```

### Testing
```bash
yarn test                  # Run Vitest tests once
yarn test:watch            # Run tests in watch mode
yarn test:coverage         # Generate v8 coverage reports
```

### Building
```bash
yarn build                 # TypeScript compile + Vite build
yarn build-keycloak-theme  # Full build including JAR generation (requires Maven)
```

**Important**: Building the Keycloak theme requires Maven (>= 3.1.1) and Java (>= 7) to be installed and `mvn` must be in PATH.

### Code Quality
```bash
yarn format               # Format code with Prettier
```

## Architecture

### Core Keycloakify Concepts

**KcContext**: The central data structure containing all Keycloak page state (user info, realm config, URLs, messages, etc.). It's injected by Keycloak at runtime or mocked during development.

**Page Routing**: Keycloak determines which page to render via `kcContext.pageId` (e.g., `"login.ftl"`, `"register.ftl"`). The main router is in `src/login/KcPage.tsx`.

**Template Pattern**: All pages use a common `Template` component (`src/login/Template.tsx`) that provides the layout, language selector, messages, and social providers.

### Directory Structure

```
src/
├── kc.gen.tsx                    # Auto-generated by Keycloakify (DO NOT EDIT)
├── main.tsx                      # Entry point
├── setupTests.ts                 # Vitest configuration
├── login/                        # Login theme implementation
│   ├── KcContext.ts             # TypeScript types for extending KcContext
│   ├── KcPage.tsx               # Main page router (switch on pageId)
│   ├── Template.tsx             # Shared layout/wrapper for all pages
│   ├── UserProfileFormFields.tsx # Reusable form field renderer
│   ├── PasswordWrapper.tsx      # Password visibility toggle component
│   ├── i18n.ts                  # Internationalization setup
│   ├── index.css                # Login theme styles
│   └── pages/                   # Individual page implementations
│       ├── Login.tsx
│       ├── Register.tsx
│       ├── LoginResetPassword.tsx
│       └── ...
├── components/
│   ├── SocialIcon.tsx           # Social provider icons
│   └── ui/                      # shadcn/ui components
│       ├── button.tsx
│       ├── card.tsx
│       ├── input.tsx
│       └── ...
└── lib/
    └── utils.ts                 # Utility functions (e.g., cn())
```

### Key Files

**`src/kc.gen.tsx`**: Auto-generated file containing theme configuration. Regenerated by Keycloakify commands - never edit manually.

**`src/login/KcContext.ts`**: Type definitions for extending the base Keycloak context. Use `KcContextExtension` to add custom properties globally, and `KcContextExtensionPerPage` to add properties specific to certain pages (e.g., adding `social` to `register.ftl`).

**`src/login/KcPage.tsx`**: The main router that maps `kcContext.pageId` values to specific page components. Each page receives `kcContext`, `i18n`, `classes`, `Template`, and other props. Pages not explicitly handled fall back to `DefaultPage` from Keycloakify.

**`src/login/Template.tsx`**: The shared UI shell for all login pages. Includes:
- Language selector (top-right)
- Card layout with Sarafrika branding
- Message display (error/success/warning/info)
- Social provider section
- "Try another way" link handling

**`src/login/UserProfileFormFields.tsx`**: Dynamic form field renderer used by Register and LoginUpdateProfile pages. Handles Keycloak's user profile configuration including validation, conditional fields, and internationalization.

**`vite.config.ts`**: Special configuration that conditionally loads plugins:
- When running tests (VITEST=true), Tailwind and Keycloakify plugins are disabled
- Uses `@` alias pointing to `./src`
- Vitest configuration embedded here (not in separate vitest.config.ts)

### UI Component Library

This project uses **shadcn/ui** components (via `components.json`) built on top of:
- **Radix UI** primitives for accessibility
- **Tailwind CSS v4** for styling
- **class-variance-authority** and **clsx** for conditional classes

The `cn()` utility in `src/lib/utils.ts` merges Tailwind classes properly.

### Testing Strategy

Tests use **Vitest** + **Testing Library** for component-focused specs. See `src/components/SocialIcon.test.tsx` as a template.

Test setup:
- `jsdom` environment for DOM simulation
- Global test utilities via `setupTests.ts`
- Coverage via v8 provider

When writing tests:
- Place tests next to components (`.test.tsx` suffix)
- Use Testing Library queries (`screen.getBy*`, `screen.findBy*`)
- Exclude Storybook files from coverage

### Internationalization

The `useI18n` hook (from `src/login/i18n.ts`) provides:
- `msg()`: Returns ReactNode with formatted message
- `msgStr()`: Returns string message
- `currentLanguage`: Current locale info
- `enabledLanguages`: Available languages for selector

Messages come from Keycloak's default message bundles. You can override or add custom messages following Keycloakify's i18n documentation.

## Development Workflow

### Adding a New Page

1. Create the page component in `src/login/pages/YourPage.tsx`
2. Import it lazily in `src/login/KcPage.tsx`
3. Add a case for the pageId (e.g., `"your-page.ftl"`) in the switch statement
4. Pass standard props: `kcContext`, `i18n`, `classes`, `Template`, `doUseDefaultCss={false}`

### Extending KcContext

To add custom properties available in `kcContext`:

**Globally** (all pages): Edit `KcContextExtension` in `src/login/KcContext.ts`

**Per-page**: Edit `KcContextExtensionPerPage` in `src/login/KcContext.ts`

Example: The register page has `social` providers added via `KcContextExtensionPerPage`.

### Initializing Additional Themes

```bash
npx keycloakify initialize-account-theme  # Add account management theme
npx keycloakify initialize-email-theme    # Add email templates theme
```

These commands scaffold additional theme types beyond login.

## CI/CD

The project uses GitHub Actions (`.github/workflows/build.yaml`) with two jobs:

1. **test**: Runs `yarn test` on all pushes and PRs
2. **build**: Runs after tests pass, builds the Keycloak theme, and pushes a Docker image to Docker Hub

The Docker image (defined in `Dockerfile`) bundles Keycloak with the custom theme JAR from `dist_keycloak/`.

**Release process**: Update `package.json` version and push to trigger a release build.

## Important Patterns

### Class Management

The `kcClsx` utility (from Keycloakify) generates class names based on `classes` prop and `doUseDefaultCss` flag. In this project, `doUseDefaultCss={false}` everywhere since Tailwind provides all styling.

The `classes` object (defined in `KcPage.tsx`) satisfies `{ [key in ClassKey]?: string }` and is empty by default.

### Password Confirmation

The `doMakeUserConfirmPassword` constant (in `KcPage.tsx`) controls whether Register and LoginUpdateProfile pages show password confirmation fields.

### Lazy Loading

All page components are lazy-loaded to optimize bundle size. Use `<Suspense>` wrappers (already present in `KcPage.tsx`).

### Social Providers

Social login buttons are rendered via `socialProvidersNode` passed to Template. Individual provider icons are handled by `SocialIcon.tsx` which maps provider names to Lucide icons.

## Testing the Theme

For local testing with a real Keycloak instance, see [Keycloakify Testing Documentation](https://docs.keycloakify.dev/testing-your-theme).

For customization strategies, see [Keycloakify Customization Documentation](https://docs.keycloakify.dev/customization-strategies).

## Configuration Files

- **`components.json`**: shadcn/ui configuration
- **`eslint.config.js`**: ESLint configuration (flat config format)
- **`.prettierrc.json`**: Prettier formatting rules
- **`tsconfig.json`**: TypeScript compiler options
- **`vite.config.ts`**: Vite and Vitest configuration

## Troubleshooting

**Tests failing**: Ensure VITEST=true is set when running tests so Tailwind plugin doesn't interfere

**Build fails**: Verify Maven and Java are installed and `mvn` is in PATH

**Type errors in kcContext**: Check that custom properties are properly declared in `KcContext.ts`

**Styling issues**: Remember that Keycloak injects pages into iframes; use `useSetClassName` (from Keycloakify) to style html/body elements